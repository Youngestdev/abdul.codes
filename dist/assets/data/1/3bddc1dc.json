{"data":{"post":{"id":"9d72ce2130056fe297fd6f4d5e5b80aa","title":"Building an open source OPA management application.","content":"<blockquote>\n<p>I'm attempting to run my engineering processes on my blog.</p>\n</blockquote>\n<p>The policy management application is born from the need to manage Open Policy Agent ( OPA ) policies written in <a href=\"https://www.openpolicyagent.org/docs/latest/policy-language/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">REGO</a> from a user interface for non-technical users and an API through JSON for technical users.</p>\n<p>The users of this policy management application are thereby classified into two:</p>\n<ul>\n<li>Non-technical users.</li>\n<li>Technical users: developers ideally.</li>\n</ul>\n<h1 id=\"user-definitions\"><a href=\"#user-definitions\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>User definitions</h1>\n<h2 id=\"non-technical-users\"><a href=\"#non-technical-users\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Non-technical users</h2>\n<p>These ideally are system administrators or anyone who is tasked with managing authorization rules for a defined resource and has no prior experience writing REGO or is not a programmer.</p>\n<h2 id=\"technical-users\"><a href=\"#technical-users\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Technical users</h2>\n<p>These are developers who can interact with the API directly and manage their policies with JSON. The API has been built to translate JSON to REG0 and can be used as a standalone i.e interacting with our hosted version or forked and used in-house.</p>\n<blockquote>\n<p>It is important to note that the JSON sent adheres to the structure defined by the <a href=\"https://github.com/r-scheele/rego_builder/issues/1\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">API standards</a>.</p>\n</blockquote>\n<h1 id=\"api-design\"><a href=\"#api-design\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>API Design</h1>\n<p>The API design for the management of the policies is split into three sections:</p>\n<ul>\n<li>Translating JSON to REGO</li>\n<li>CRUD operations for policies for persistence.</li>\n<li>GitHub integration.</li>\n</ul>\n<blockquote>\n<p>Setting the API up can be found <a href=\"https://github.com/r-scheele/rego_builder#installation\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a>.</p>\n</blockquote>\n<h2 id=\"translating-json-to-rego\"><a href=\"#translating-json-to-rego\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Translating JSON to REGO</h2>\n<p>A set of functions, let’s call them the <strong>translator logic</strong>, do the job of creating the REGO policies. These functions are stored [here - WIP documentation].</p>\n<p>The JSON translated to REGO as stated earlier must conform to defined standards. A rule is defined in this manner:</p>\n<div class=\"gridsome-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"command\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"input_prop_equals\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"properties\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"input_property\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"request_method\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"value\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"GET\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-text\">command</code> key represents the operation to be defined as REGO. In this example, <code class=\"language-text\">input_prop_equals</code> translates to the assignment property <code class=\"language-text\">==</code>. The list of commands and their definition is explained [WIP - Documentation By Habeeb].</p>\n<p>The JSON above translates to the following in REGO:</p>\n<div class=\"gridsome-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">input<span class=\"token punctuation\">.</span>request_method <span class=\"token operator\">==</span> <span class=\"token string\">\"GET\"</span></code></pre></div>\n<h2 id=\"crud-operations\"><a href=\"#crud-operations\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>CRUD Operations</h2>\n<p>The API is built to accommodate all CRUD operations. The list of routes defined currently are:</p>\n<ul>\n<li><code class=\"language-text\">/policies</code>: List all policies created by a user.</li>\n<li><code class=\"language-text\">/policies</code>: <strong>POST</strong> route for adding a new policy.</li>\n<li><code class=\"language-text\">/policies/{policy_id}</code>: route for <strong>GET</strong>, <strong>UPDATE</strong> and <strong>DELETE</strong> operations respectively.</li>\n</ul>\n<p>The request lifecycle for a <strong>POST</strong> request is illustrated thus:</p>\n<p><img src=\"https://res.cloudinary.com/laisi/image/upload/v1654718824/Untitled_myacve.png\" alt=\"Untitled\"></p>\n<p>Each request sent to the API is made to pass through a series of checks:</p>\n<ul>\n<li>The validity of the request body, thanks to Pydantic model validations.</li>\n<li>The uniqueness of the policy. If such a policy exists, an HTTP 409 is returned. In such a case, it’ll be ideal to use the <strong>UPDATE</strong> route.</li>\n</ul>\n<blockquote>\n<p>A concise explanation of how requests are sent and their responses can be viewed in this <a href=\"https://github.com/r-scheele/rego_builder/pull/5#issue-1245453527\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">PR</a>. [ A more concise one is one the way - WIP DOC.]</p>\n</blockquote>\n<h2 id=\"github-integration\"><a href=\"#github-integration\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>GitHub integration</h2>\n<p>The primary design of the API is targeted at users who want to manage their OPA policies stored in a repository. </p>\n<p>As such, on initialization of the API and signing into the client on the frontend, a repo is supplied and policies go through either of the CRUD operations when subjected to either from the API/UI client.</p>\n<h3 id=\"concern\"><a href=\"#concern\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Concern.</h3>\n<p>Primarily, the repository is defined as an environment variable alongside the tokens needed to carry out operations. In order to allow the frontend client set the data, I’m proposing the following options:</p>\n<ul>\n<li>Create a route on the backend that allows the frontend set the data needed for the settings. This can as well be done on the <code class=\"language-text\">/authorize</code> route and then return the settings instance which will then be used all through the application.</li>\n<li>Eliminate the use of environment variables to set GitHub repository variables and instead retrieve them from an injected dependency. This option will create an additional layer of work for users who prefer to use <strong>Personal Access Tokens</strong> to manage their activities as opposed to <strong>Signing in every 8 hours to use the API</strong>.</li>\n</ul>\n<blockquote>\n<p>The problem above is set to medium priority and will be focused on after the UI screens are complete. For now, the repository configuration remains in the backend.</p>\n</blockquote>\n<h1 id=\"todo-for-the-api\"><a href=\"#todo-for-the-api\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Todo for the API.</h1>\n<ul>\n<li>Fully integrate the GitHub authentication to allow multiple users make changes from the frontend - WIP.</li>\n<li>\n<p>Concise documentation covering the technical specs and the how-tos of the API - WIP.</p>\n<ul>\n<li>Highlight installation steps for users who wish to self-host the API.</li>\n</ul>\n</li>\n<li>Like <code class=\"language-text\">pygeoapi</code>, provide a CLI tool/option that enables users to convert JSON files to REGO files.</li>\n</ul>\n<h1 id=\"frontend-client\"><a href=\"#frontend-client\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Frontend Client</h1>\n<p>The frontend client application is currently a <a href=\"https://app-demo-youngestdev.cloud.okteto.net/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">WIP</a>. It is being built primarily for non-technical users to enable them to manage their policies.</p>\n<p>The current screen available for the frontend is:</p>\n<ul>\n<li>\n<p>Create policy</p>\n<p>  <img src=\"https://res.cloudinary.com/laisi/image/upload/v1654718814/Untitled_1_ofsozv.png\" alt=\"Untitled\">\n</p>\n</li>\n</ul>\n<p><img src=\"https://res.cloudinary.com/laisi/image/upload/v1654718827/Screenshot_2022-06-08_at_10.40.10_fxftq5.png\" alt=\"Screenshot 2022-06-08 at 10.40.10.png\"></p>\n<ul>\n<li>\n<p>View policy</p>\n<p>  <img src=\"https://res.cloudinary.com/laisi/image/upload/v1654718827/Screenshot_2022-06-08_at_10.42.19_xjo7it.png\" alt=\"Screenshot 2022-06-08 at 10.42.19.png\">\n</p>\n</li>\n</ul>\n<p>The UPDATE and DELETE routes are currently a <strong>WIP</strong>.</p>\n<h2 id=\"todo-for-the-frontend\"><a href=\"#todo-for-the-frontend\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Todo for the Frontend</h2>\n<ul>\n<li>Implement UPDATE and DELETE screens.</li>\n<li>Complete <strong>Sign in with GitHub</strong></li>\n</ul>\n<h1 id=\"authorization\"><a href=\"#authorization\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Authorization</h1>\n<p>To disallow retrieval of policies by just anybody, the Sign in with GitHub will be used to retrieve user data which will, in turn, be used to store data and act as an accessor when attempting to perform any operation.</p>\n<p>The headers for authorization will <em>most likely</em> be encoded in JWT format. This is still undergoing deliberation - myself and Habeeb.</p>\n","date":"8 June 2022","timeToRead":4,"image":null}},"context":{}}