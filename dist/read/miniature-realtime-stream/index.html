<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="lang">
  <head>
    <title data-vue-tag="true">Miniature Realtime Stream - Abdul&#x27;s Musings</title><meta data-vue-tag="true" charset="utf-8"><meta data-vue-tag="true" name="generator" content="Gridsome v0.6.9"><meta data-vue-tag="true" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="true" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="true" data-key="description" name="description" content="A simple blog to pen my findings and idk idk."><meta data-vue-tag="true" name="google-site-verification" content="sIbGxCmGnUobPKM6wa8WJZaHqfW7XJZP6WUEDaIo90o"><meta data-vue-tag="true" name="description" content><meta data-vue-tag="true" name="twitter:card" content="summary"><meta data-vue-tag="true" name="twitter:creator" content="@kvng_zeez"><meta data-vue-tag="true" name="twitter:description" content><meta data-vue-tag="true" name="twitter:image" content=""><meta data-vue-tag="true" name="twitter:site" content="@kvng_zeez"><meta data-vue-tag="true" property="og:type" content="article"><meta data-vue-tag="true" property="og:title" content="Miniature Realtime Stream"><meta data-vue-tag="true" property="og:description" content><meta data-vue-tag="true" property="og:url" content="undefinedundefined"><link data-vue-tag="true" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Stylish&amp;display=swap"><link data-vue-tag="true" rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans&amp;display=swap"><link data-vue-tag="true" rel="favicon" href="https://res.cloudinary.com/adeshina/image/upload/v1597158363/x8kh4xqni1ktuc4mb3v7.ico"><script data-vue-tag="true" src="https://platform.twitter.com/widgets.js" async="true"></script><noscript data-vue-tag="true" ><style>.g-image--loading{display:none;}</style></noscript><link rel="preload" href="/assets/css/0.styles.c31b00c3.css" as="style"><link rel="preload" href="/assets/js/app.cb174b5f.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--post-vue.c75ab964.js" as="script"><link rel="prefetch" href="/assets/js/page--node-modules--gridsome--app--pages--404-vue.c976386a.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.cc2794a6.js"><link rel="prefetch" href="/assets/js/vendors~page--src--templates--post-vue.52a6764f.js"><link rel="stylesheet" href="/assets/css/0.styles.c31b00c3.css">
  </head>
  <body data-vue-tag="">
    <div data-server-rendered="true" id="app" class="layout"><br><a id="go-back" aria-label="Go back" class="link">‚Üê Go Back</a><div class="post-title"><h1>Miniature Realtime Stream</h1><p class="post-date"> 23 March 2025 | 5 min read</p></div><!----><div class="post-content"><p><p>Building Mercury has been fun. I have learned more about software development and MongoDB in particular. For instance, I had never had to make use of MongoDB aggregations until Mercury, and it has been fascinating.</p>
<p>This little article is just to talk about MongoDB's <code class="language-text">.watch()</code>. In a few words, what the method does is to <em>watch</em> the changes going on in and around a collection. For example, it can log the streams of insert, update, and delete operations happening to the selected collection.</p>
<h2 id="okay-what-was-i-building"><a href="#okay-what-was-i-building" aria-hidden="true"><span class="icon icon-link"></span></a>Okay, what was I building?</h2>
<p>So, I wanted to stream the changes going on in the database and communicate it via a websocket channel to the frontend guys. There's an activity tab that should update the user on changes especially as the application is a multi-user-tied-to-one-account application.</p>
<h2 id="so"><a href="#so" aria-hidden="true"><span class="icon icon-link"></span></a>So...</h2>
<p><strong>You need to enable pre-image and post-image. I enabled it for all my collections from my mongosh console by running: </strong></p>
<div class="gridsome-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">const collections <span class="token operator">=</span> db.getCollectionNames<span class="token punctuation">(</span><span class="token punctuation">)</span>.filter<span class="token punctuation">(</span>c <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">!</span>c.startsWith<span class="token punctuation">(</span><span class="token string">'system.'</span><span class="token punctuation">))</span><span class="token punctuation">;</span>

collections.forEach<span class="token punctuation">(</span>collectionName <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  db.runCommand<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">"collMod"</span><span class="token builtin class-name">:</span> collectionName,
    <span class="token string">"changeStreamPreAndPostImages"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">"enabled"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>I started by building out the websocket connection manager:</p>
<div class="gridsome-highlight" data-language="py"><pre class="language-py"><code class="language-py"><span class="token keyword">import</span> asyncio

<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> WebSocket
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict
<span class="token keyword">from</span> mercury<span class="token punctuation">.</span>infra<span class="token punctuation">.</span>logger <span class="token keyword">import</span> logger


<span class="token keyword">class</span> <span class="token class-name">ConnectionManager</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>active_connections<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> WebSocket<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        self<span class="token punctuation">.</span>lock <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> websocket<span class="token punctuation">:</span> WebSocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> self<span class="token punctuation">.</span>lock<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>active_connections<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span> <span class="token operator">=</span> websocket
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Client </span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string"> connected. Active connections: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>active_connections<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">disconnect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> self<span class="token punctuation">.</span>lock<span class="token punctuation">:</span>
            <span class="token keyword">if</span> user_id <span class="token keyword">in</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">:</span>
                <span class="token keyword">del</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Client </span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string"> disconnected. Active connections: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>active_connections<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">send_to_client</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> self<span class="token punctuation">.</span>lock<span class="token punctuation">:</span>
            <span class="token keyword">if</span> user_id <span class="token keyword">in</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">:</span>
                websocket <span class="token operator">=</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span>
                <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send_text<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
                logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Message sent to client </span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"No active connection found for user </span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></code></pre></div>
<p>It's pretty straightforward. It handles the connection, keeping track and sending back to the designated users.</p>
<p>Then, the main action - the websocket route. For changes to be listened to, a connection needs to be established for a user. I'm not going to go deep at all, I'm just going to illustrate it. Pardon me, these days, I have become lazy.</p>
<p>Let's go however. I started by connecting a valid user aka storing the user's credential for subsequent communication:</p>
<div class="gridsome-highlight" data-language="py"><pre class="language-py"><code class="language-py"><span class="token keyword">if</span> <span class="token keyword">not</span> client_id <span class="token keyword">and</span> <span class="token keyword">not</span> token<span class="token punctuation">:</span>
    <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>close<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token number">1008</span><span class="token punctuation">,</span> reason<span class="token operator">=</span><span class="token string">"Client ID and token required"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>

<span class="token keyword">if</span> app<span class="token punctuation">.</span>get_client_type_from_client_id<span class="token punctuation">(</span>client_id<span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>close<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> reason<span class="token operator">=</span><span class="token string">"Invalid client ID"</span><span class="token punctuation">)</span>

user <span class="token operator">=</span> app<span class="token punctuation">.</span>authentication_service<span class="token punctuation">.</span>decode_jwt<span class="token punctuation">(</span>
    token
<span class="token punctuation">)</span>

db <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span>database<span class="token punctuation">.</span>get_db<span class="token punctuation">(</span><span class="token punctuation">)</span>

valid_user <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>users<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">"email"</span><span class="token punctuation">:</span> user<span class="token punctuation">[</span><span class="token string">"user_id"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> valid_user <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>close<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> reason<span class="token operator">=</span><span class="token string">"User does not exist"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>

<span class="token keyword">await</span> app<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>valid_user<span class="token punctuation">[</span><span class="token string">"_id"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> websocket<span class="token punctuation">)</span></code></pre></div>
<p>First, I try to ascertain the validity of the client's ID, token and user before proceeding to connect the user, I make use of the ID as it's unique for each of them.</p>
<h2 id="let-the-watch-party-begin"><a href="#let-the-watch-party-begin" aria-hidden="true"><span class="icon icon-link"></span></a>Let the watch party begin</h2>
<p>In a <code class="language-text">try..except</code> block, I start the main party. I need to be up to date with all the operations but I don't need all the information being passed around as well. Therefore, I wrote an aggregation pipeline to return just the fields I'm interested in:</p>
<div class="gridsome-highlight" data-language="py"><pre class="language-py"><code class="language-py">pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span><span class="token string">'$match'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">'operationType'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">'$in'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'insert'</span><span class="token punctuation">,</span> <span class="token string">'update'</span><span class="token punctuation">,</span> <span class="token string">'delete'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">"$project"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"operationType"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"documentKey"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"ns"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"fullDocument.creator_id"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"fullDocument.owner._id"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"fullDocument.owned_by"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"fullDocument.quantity_in_stock"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"fullDocument.reorder_point"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"fullDocumentBeforeChange.owned_by"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"fullDocumentBeforeChange.creator_id"</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre></div>
<p>In some cases, I need the full document before a change is effected. An example is a delete operation where I need to get the document details to update the stream. I defined them in an options dict:</p>
<div class="gridsome-highlight" data-language="py"><pre class="language-py"><code class="language-py">options <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'full_document'</span><span class="token punctuation">:</span> <span class="token string">'updateLookup'</span><span class="token punctuation">,</span>
    <span class="token string">'full_document_before_change'</span><span class="token punctuation">:</span> <span class="token string">'required'</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Then I begin the watch operation and store the operation type <code class="language-text">operation_type</code>, document key (ID) <code class="language-text">document_key</code>, and the collection <code class="language-text">collection</code>:</p>
<div class="gridsome-highlight" data-language="py"><pre class="language-py"><code class="language-py"><span class="token keyword">async</span> <span class="token keyword">with</span> db<span class="token punctuation">.</span>watch<span class="token punctuation">(</span>pipeline<span class="token punctuation">,</span> <span class="token operator">**</span>options<span class="token punctuation">)</span> <span class="token keyword">as</span> change_stream<span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">for</span> change <span class="token keyword">in</span> change_stream<span class="token punctuation">:</span>
        operation_type <span class="token operator">=</span> change<span class="token punctuation">[</span><span class="token string">'operationType'</span><span class="token punctuation">]</span>
        document_key <span class="token operator">=</span> change<span class="token punctuation">[</span><span class="token string">'documentKey'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"_id"</span><span class="token punctuation">]</span>
        collection <span class="token operator">=</span> change<span class="token punctuation">[</span><span class="token string">"ns"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"coll"</span><span class="token punctuation">]</span></code></pre></div>
<p>With all these in place, I defined the specific actions to be carried out (mainly websocket broadcast) for each action. Here's the one for the <code class="language-text">delete</code> operation:</p>
<div class="gridsome-highlight" data-language="py"><pre class="language-py"><code class="language-py"><span class="token keyword">if</span> operation_type <span class="token operator">==</span> <span class="token string">'delete'</span><span class="token punctuation">:</span>
    full_doc <span class="token operator">=</span> change<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'fullDocumentBeforeChange'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">match</span> collection<span class="token punctuation">:</span>
        <span class="token keyword">case</span> <span class="token string">"inventory_items"</span><span class="token punctuation">:</span>
            business <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>businesses<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token string">"_id"</span><span class="token punctuation">:</span> full_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"owned_by"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            recipient <span class="token operator">=</span> business<span class="token punctuation">[</span><span class="token string">"owner"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">if</span> business <span class="token keyword">else</span> <span class="token boolean">None</span>
        <span class="token keyword">case</span> <span class="token string">"orders"</span><span class="token punctuation">:</span>
            business <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>businesses<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token string">"_id"</span><span class="token punctuation">:</span> full_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"creator_id"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            recipient <span class="token operator">=</span> business<span class="token punctuation">[</span><span class="token string">"owner"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">if</span> business <span class="token keyword">else</span> <span class="token boolean">None</span>
        <span class="token keyword">case</span> <span class="token keyword">_</span><span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Unhandled collection for delete: </span><span class="token interpolation"><span class="token punctuation">{</span>collection<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            recipient <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">if</span> recipient<span class="token punctuation">:</span>
        message <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"Change detected: </span><span class="token interpolation"><span class="token punctuation">{</span>operation_type<span class="token punctuation">}</span></span><span class="token string"> on document </span><span class="token interpolation"><span class="token punctuation">{</span>document_key<span class="token punctuation">}</span></span><span class="token string"> in collection </span><span class="token interpolation"><span class="token punctuation">{</span>collection<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Attempting to send message to recipient: </span><span class="token interpolation"><span class="token punctuation">{</span>recipient<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> app<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span>send_to_client<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>recipient<span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"No recipient found for change: </span><span class="token interpolation"><span class="token punctuation">{</span>operation_type<span class="token punctuation">}</span></span><span class="token string"> in </span><span class="token interpolation"><span class="token punctuation">{</span>collection<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></code></pre></div>
<p>The action for <code class="language-text">insert</code> and <code class="language-text">update</code> are similar si they're grouped togehter:</p>
<div class="gridsome-highlight" data-language="py"><pre class="language-py"><code class="language-py"><span class="token keyword">elif</span> operation_type <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'insert'</span><span class="token punctuation">,</span> <span class="token string">'update'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    full_doc <span class="token operator">=</span> change<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'fullDocument'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">match</span> collection<span class="token punctuation">:</span>
        <span class="token keyword">case</span> <span class="token string">"orders"</span><span class="token punctuation">:</span>
            business <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>businesses<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token string">"_id"</span><span class="token punctuation">:</span> full_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"creator_id"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"owner"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            recipient <span class="token operator">=</span> business<span class="token punctuation">[</span><span class="token string">"owner"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">if</span> business <span class="token keyword">else</span> <span class="token boolean">None</span>
        <span class="token keyword">case</span> <span class="token string">"inventory_items"</span><span class="token punctuation">:</span>
            business <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>businesses<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token string">"_id"</span><span class="token punctuation">:</span> full_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"owned_by"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"owner"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            recipient <span class="token operator">=</span> business<span class="token punctuation">[</span><span class="token string">"owner"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">if</span> business <span class="token keyword">else</span> <span class="token boolean">None</span>

            <span class="token keyword">if</span> full_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"quantity_in_stock"</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> full_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"reorder_point"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">await</span> app<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span>send_to_client<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>recipient<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                <span class="token string">"Stock low, please restock the inventory to continue issuing orders."</span><span class="token punctuation">)</span>

        <span class="token keyword">case</span> <span class="token keyword">_</span><span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Unhandled collection for </span><span class="token interpolation"><span class="token punctuation">{</span>operation_type<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>collection<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            recipient <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">if</span> recipient<span class="token punctuation">:</span>
        message <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"Change detected: </span><span class="token interpolation"><span class="token punctuation">{</span>operation_type<span class="token punctuation">}</span></span><span class="token string"> on document </span><span class="token interpolation"><span class="token punctuation">{</span>document_key<span class="token punctuation">}</span></span><span class="token string"> in collection </span><span class="token interpolation"><span class="token punctuation">{</span>collection<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Attempting to send message to recipient: </span><span class="token interpolation"><span class="token punctuation">{</span>recipient<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> app<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span>send_to_client<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>recipient<span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"No recipient found for change: </span><span class="token interpolation"><span class="token punctuation">{</span>operation_type<span class="token punctuation">}</span></span><span class="token string"> in </span><span class="token interpolation"><span class="token punctuation">{</span>collection<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Unhandled operation type: </span><span class="token interpolation"><span class="token punctuation">{</span>operation_type<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></code></pre></div>
<p>The end:</p>
<div class="gridsome-highlight" data-language="py"><pre class="language-py"><code class="language-py"><span class="token keyword">except</span> asyncio<span class="token punctuation">.</span>CancelledError<span class="token punctuation">:</span>
    <span class="token comment"># Handle cancellation gracefully</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Task was cancelled. Cleaning up..."</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> WebSocketDisconnect<span class="token punctuation">:</span>
    <span class="token keyword">await</span> app<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span>disconnect<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>valid_user<span class="token punctuation">[</span><span class="token string">"_id"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"User {valid_user["</span></span>_id<span class="token string">"]} is disconnected"</span><span class="token punctuation">)</span></code></pre></div>
<p>I connected an active session:</p>
<div class="gridsome-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">Client 67a9f47786c624adede7---- connected. Active connections: <span class="token punctuation">[</span><span class="token string">'67a9f47786c624adede7----'</span><span class="token punctuation">]</span></code></pre></div>
<div class="gridsome-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">Change detected: delete on document 67aa00fce173bf9d4ba2---- <span class="token keyword">in</span> collection orders</code></pre></div>
<h2 id="if-you-were"><a href="#if-you-were" aria-hidden="true"><span class="icon icon-link"></span></a>If you were...</h2>
<p>If you were to build a streaming endpoint like this, how would you approach it?</p>
</p><hr><div id="disqus_thread"></div></div><div class="footer"><p>
      Check my <a href="//github.com/Youngestdev" class="link">GitHub</a></p></div></div>
    <script src="/assets/js/app.cb174b5f.js" defer></script><script src="/assets/js/page--src--templates--post-vue.c75ab964.js" defer></script>
  </body>
</html>
